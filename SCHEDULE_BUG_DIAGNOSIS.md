# Schedule/Calendar Consistency Bug Diagnosis

## ROOT CAUSES IDENTIFIED (FIXED)

### 1. Date Format Inconsistency ✅ FIXED
**Problem**: Different parts of the app used different date formats:
- `workout-store.ts`: `date.toISOString()` → "2026-01-09T00:00:00.000Z" (UTC)
- `workouts.tsx`: `date.toDateString()` → "Thu Jan 09 2026" (local)
- ViewAllWeeksModal: Array INDEX instead of date matching

**Solution**: Created canonical `toLocalDateKey()` function that returns "YYYY-MM-DD" format, used consistently everywhere.

### 2. ViewAllWeeksModal Used Array INDEX ✅ FIXED
**Problem**: `weekWorkouts[dayIndex]` assumed array position matched calendar day
**Solution**: Now uses `findWorkoutByDate()` to match workouts by their actual date field

### 3. Skip Day REMOVED Entry Instead of REST ✅ FIXED
**Problem**: `removeWorkoutFromDate()` filtered out the workout entirely
**Solution**: Now converts to REST day with `isRestDay: true, title: 'Rest Day'` - entry remains visible

### 4. EditPlanScreen Used Array INDEX ✅ FIXED
**Problem**: Selected days stored as array indices, not date keys
**Solution**: Now stores `dateKey` strings ("YYYY-MM-DD") and uses `findWorkoutIndexByDate()`

## FILES CHANGED

1. `/app/apps/native/src/stores/workout-store.ts`
   - Added canonical date utilities: `toLocalDateKey()`, `getMondayOfWeek()`, `findWorkoutByDate()`, `findWorkoutIndexByDate()`
   - Fixed `removeWorkoutFromDate()` to convert to REST instead of delete
   - Fixed `syncFromBackend()` to handle both array and object responses, match by date

2. `/app/apps/native/src/components/ViewAllWeeksModal.tsx`
   - Now calculates actual dates for each day slot
   - Uses `findWorkoutByDate()` instead of array index
   - Imports new date utilities from workout-store

3. `/app/apps/native/src/components/EditPlanScreen.tsx`
   - Changed `selectedDays` from `number[]` to `string[]` (date keys)
   - All operations now use `findWorkoutIndexByDate()` to locate workouts
   - Uses consistent date key format

## CANONICAL DATE FORMAT

All schedule operations now use:
```
YYYY-MM-DD (e.g., "2026-01-09")
```

Generated by `toLocalDateKey(date)` function, ensuring:
- No timezone drift (local date, not UTC)
- String comparison (no Date object quirks)
- Consistent across all components

## SKIP DAY BEHAVIOR (FIXED)

Before: Workout removed from array → Day disappeared from calendar
After: Workout converted to REST → `{ isRestDay: true, title: 'Rest Day' }` → Day remains visible
